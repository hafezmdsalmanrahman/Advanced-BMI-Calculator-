<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡¶° ‡¶π‡ßá‡¶≤‡¶• ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9530643' data-sdk='show_9530643'></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --tg-theme-bg-color: #0f0c29;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #9ca3af;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: rgba(26, 26, 46, 0.6);
            --tg-theme-input-bg-color: rgba(71, 85, 105, 0.4);
        }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { font-family: 'Hind Siliguri', sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); transition: background-color 0.3s, color 0.3s; }
        body.original-gradient-bg { background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #1a1a2e); background-size: 400% 400%; animation: gradient-animation 15s ease infinite; }
        .main-card { background: var(--tg-theme-secondary-bg-color); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-card { background-color: var(--tg-theme-secondary-bg-color); border-radius: 20px; }
        .tab-button.active { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
        .tab-button { color: var(--tg-theme-hint-color); }
        .gender-button.selected { border-color: var(--tg-theme-button-color); background-color: rgba(59, 130, 246, 0.2); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .input-glow, .input-glow:focus { background-color: var(--tg-theme-input-bg-color); color: var(--tg-theme-text-color); }
        .input-glow:focus { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); border-color: var(--tg-theme-button-color); }
        label, h1, h2, h3 { color: var(--tg-theme-text-color); }
        .gender-button, .text-white { color: var(--tg-theme-text-color); }
        #clear-history-btn { background-color: #ef4444; }
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        .toast { animation: toast-in 0.5s forwards; } .toast.closing { animation: toast-out 0.5s forwards; }
        @keyframes card-pop-in { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-card .animated-card { animation: card-pop-in 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; opacity: 0; }
        #modal-backdrop { transition: opacity 0.3s ease-in-out; }
        #modal-content { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; max-height: 90vh; overflow-y: auto;}
        .tg-hidden { display: none !important; }
        #unlock-screen { animation: card-pop-in 0.5s forwards; }
        #unlock-report-btn { background: linear-gradient(45deg, #22c55e, #16a34a); transition: all 0.3s ease; }
        #unlock-report-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(34, 197, 94, 0.6); }
    </style>
</head>
<body class="original-gradient-bg">
    <!-- HTML Structure is unchanged -->
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="main-card w-full max-w-md p-6 sm:p-8">
            <h1 class="text-3xl font-bold text-center mb-6"><i class="fas fa-tachometer-alt-fast mr-2"></i> ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡¶° ‡¶π‡ßá‡¶≤‡¶• ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
            <div id="tab-controls" class="flex bg-indigo-900/40 rounded-lg p-1 mb-6">
                <button id="calculator-tab-btn" class="tab-button w-1/2 p-2 rounded-lg font-semibold transition-colors active">‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</button>
                <button id="history-tab-btn" class="tab-button w-1/2 p-2 rounded-lg font-semibold transition-colors">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</button>
            </div>
            <div id="calculator-tab">
                <form id="healthForm" autocomplete="off" class="space-y-4">
                    <div><label class="block text-lg font-medium mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó</label><div class="flex gap-4"><button type="button" data-gender="male" class="gender-button w-1/2 p-3 flex items-center justify-center gap-2 border-2 border-gray-600 rounded-lg transition"><i class="fas fa-mars"></i> ‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑</button><button type="button" data-gender="female" class="gender-button w-1/2 p-3 flex items-center justify-center gap-2 border-2 border-gray-600 rounded-lg transition"><i class="fas fa-venus"></i> ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ</button></div></div>
                    <div><label for="age" class="block text-lg font-medium mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßü‡¶∏</label><input type="number" id="age" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 25" class="input-glow w-full p-3 pl-4 rounded-lg border-2 border-transparent focus:outline-none transition"></div>
                    <div><label for="weight" class="block text-lg font-medium mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ú‡¶® (‡¶ï‡ßá‡¶ú‡¶ø)</label><div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-4"><i class="fas fa-weight-hanging text-gray-300"></i></span><input type="number" id="weight" step="any" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 68" class="input-glow w-full p-3 pl-12 rounded-lg border-2 border-transparent focus:outline-none transition" required></div></div>
                    <div><label class="block text-lg font-medium mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ (‡¶´‡¶ø‡¶ü, ‡¶á‡¶û‡ßç‡¶ö‡¶ø)</label><div class="flex gap-4"><input type="number" id="heightFeet" placeholder="‡¶´‡¶ø‡¶ü" class="input-glow w-1/2 p-3 pl-4 rounded-lg border-2 border-transparent focus:outline-none transition" required><input type="number" id="heightInches" placeholder="‡¶á‡¶û‡ßç‡¶ö‡¶ø" class="input-glow w-1/2 p-3 pl-4 rounded-lg border-2 border-transparent focus:outline-none transition"></div></div>
                    <div><label for="goal" class="block text-lg font-medium mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø</label><select id="goal" class="input-glow w-full p-3 rounded-lg border-2 border-transparent focus:outline-none"><option value="lose">‡¶ì‡¶ú‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã</option><option value="maintain" selected>‡¶ì‡¶ú‡¶® ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ</option><option value="gain">‡¶ì‡¶ú‡¶® ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡ßã</option></select></div>
                    <div><label for="diet-style" class="block text-lg font-medium mb-2">‡¶°‡¶æ‡ßü‡ßá‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤</label><select id="diet-style" class="input-glow w-full p-3 rounded-lg border-2 border-transparent focus:outline-none"><option value="balanced">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡¶°</option><option value="low-carb">‡¶≤‡ßã-‡¶ï‡¶æ‡¶∞‡ßç‡¶¨</option><option value="high-protein">‡¶π‡¶æ‡¶á-‡¶™‡ßç‡¶∞‡ßã‡¶ü‡¶ø‡¶®</option></select></div>
                    <div id="submit-button-container" class="pt-4 flex gap-4"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center transform hover:scale-105 duration-300">‡¶π‡ßá‡¶≤‡¶• ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® <i class="fas fa-file-medical-alt ml-2"></i></button></div>
                </form>
            </div>
            <div id="unlock-screen" class="hidden text-center p-8">
                <i class="fas fa-lock text-6xl text-yellow-400 mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá</h2>
                <p class="text-gray-300 mb-6">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡¶° ‡¶π‡ßá‡¶≤‡¶• ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶§‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</p>
                <button id="unlock-report-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center"><i class="fas fa-play mr-2"></i> ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
            <div id="history-tab" class="hidden"><div class="mb-4"><canvas id="bmiChart"></canvas></div><div id="history-log" class="space-y-2 max-h-80 overflow-y-auto"></div><button id="clear-history-btn" class="mt-4 w-full bg-red-800 text-white font-semibold py-2 rounded-lg hover:bg-red-700 transition-colors">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button></div>
        </div>
    </div>
    <div id="modal-backdrop" class="fixed inset-0 flex items-center justify-center bg-black/70 backdrop-blur-sm z-50 opacity-0 pointer-events-none"><div id="modal-content" class="modal-card w-full max-w-lg m-4 p-8 opacity-0 scale-95"></div></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
        // --- Variable Declarations ---
        const tg = window.Telegram.WebApp;
        const calculatorTabBtn = document.getElementById('calculator-tab-btn'), historyTabBtn = document.getElementById('history-tab-btn'), tabControls = document.getElementById('tab-controls'), calculatorTab = document.getElementById('calculator-tab'), historyTab = document.getElementById('history-tab'), healthForm = document.getElementById('healthForm'), genderButtons = document.querySelectorAll('.gender-button'), ageInput = document.getElementById('age'), weightInput = document.getElementById('weight'), heightFeetInput = document.getElementById('heightFeet'), heightInchesInput = document.getElementById('heightInches'), goalSelect = document.getElementById('goal'), dietStyleSelect = document.getElementById('diet-style'), submitBtnContainer = document.getElementById('submit-button-container'), modalBackdrop = document.getElementById('modal-backdrop'), modalContent = document.getElementById('modal-content'), historyLog = document.getElementById('history-log'), clearHistoryBtn = document.getElementById('clear-history-btn'), chartCanvas = document.getElementById('bmiChart'), unlockScreen = document.getElementById('unlock-screen'), unlockReportBtn = document.getElementById('unlock-report-btn');
        let bmiChartInstance = null, selectedGender = null, calculationData = null;

        // --- Event Listeners ---
        calculatorTabBtn.addEventListener('click', () => { switchTab('calculator'); try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {} });
        historyTabBtn.addEventListener('click', () => { switchTab('history'); try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {} });
        healthForm.addEventListener('submit', handleCalculation);
        clearHistoryBtn.addEventListener('click', clearHistory);
        genderButtons.forEach(button => button.addEventListener('click', () => { selectedGender = button.dataset.gender; genderButtons.forEach(btn => btn.classList.remove('selected')); button.classList.add('selected'); try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {} validateFormForTelegram(); }));
        [ageInput, weightInput, heightFeetInput, heightInchesInput].forEach(input => input.addEventListener('input', validateFormForTelegram));
        modalBackdrop.addEventListener('click', e => { if (e.target === modalBackdrop) closeModal(); });
        document.addEventListener('keydown', e => { if(e.key === "Escape" && !modalBackdrop.classList.contains('pointer-events-none')) closeModal(); });
        unlockReportBtn.addEventListener('click', showRewardedPopupAd);

        // --- Core Logic ---
        function handleCalculation(event) {
            event.preventDefault();
            if (!selectedGender) { showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error"); try { tg.HapticFeedback.notificationOccurred('error'); } catch (e) {} return; }
            const age = parseInt(ageInput.value), weightKg = parseFloat(weightInput.value), feet = parseFloat(heightFeetInput.value) || 0, inches = parseFloat(heightInchesInput.value) || 0;
            if (isNaN(age) || age < 18 || isNaN(weightKg) || (isNaN(feet) && isNaN(inches)) || weightKg <= 0 || (feet <= 0 && inches <= 0)) { showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§", "error"); try { tg.HapticFeedback.notificationOccurred('error'); } catch (e) {} return; }
            calculationData = { age, weightKg, feet, inches, goal: goalSelect.value, dietStyle: dietStyleSelect.value };
            calculatorTab.classList.add('hidden');
            tabControls.classList.add('hidden');
            unlockScreen.classList.remove('hidden');
            if(tg.initData) try { tg.MainButton.hide(); } catch(e) {}
        }

        function processAndShowResults(data) {
            const { age, weightKg, feet, inches, goal, dietStyle } = data;
            const totalInches = (feet * 12) + inches, heightInMeters = totalInches * 0.0254, heightCm = heightInMeters * 100;
            const bmi = weightKg / (heightInMeters * heightInMeters);
            const bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + (selectedGender === 'male' ? 5 : -161);
            const maintenanceCalories = bmr * 1.375;
            let targetCalories = maintenanceCalories;
            if (goal === 'lose') targetCalories -= 500; else if (goal === 'gain') targetCalories += 500;
            const macroRatios = { balanced: { protein: 0.30, carbs: 0.40, fat: 0.30 }, 'low-carb': { protein: 0.40, carbs: 0.20, fat: 0.40 }, 'high-protein': { protein: 0.50, carbs: 0.30, fat: 0.20 } };
            const macros = { protein: (targetCalories * macroRatios[dietStyle].protein) / 4, carbs: (targetCalories * macroRatios[dietStyle].carbs) / 4, fat: (targetCalories * macroRatios[dietStyle].fat) / 9 };
            const waterIntake = (weightKg * 35) / 1000;
            
            saveHistory({ date: new Date().toLocaleDateString('bn-BD'), bmi: bmi.toFixed(2), weight: weightKg });
            populateAndShowModal({ bmi, macros, waterIntake }, heightInMeters);
        }
        
        // --- FINAL CORRECTED populateAndShowModal FUNCTION ---
        function populateAndShowModal(data, heightInMeters) {
            const { bmi, macros, waterIntake } = data;
            const minHealthyWeightKg = 18.5 * (heightInMeters * heightInMeters), maxHealthyWeightKg = 24.9 * (heightInMeters * heightInMeters);
            const idealWeightRange = `${minHealthyWeightKg.toFixed(1)} - ${maxHealthyWeightKg.toFixed(1)} ‡¶ï‡ßá‡¶ú‡¶ø`;
            let bmiStatusText, bmiStatusColor;
            if(bmi < 18.5) { bmiStatusText = "‡¶ï‡¶Æ ‡¶ì‡¶ú‡¶®"; bmiStatusColor = "text-yellow-400"; }
            else if(bmi < 25) { bmiStatusText = "‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶ì‡¶ú‡¶®"; bmiStatusColor = "text-green-400"; }
            else { bmiStatusText = "‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ì‡¶ú‡¶®"; bmiStatusColor = "text-red-400"; }
            
            const reportText = `‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:\n\nüìä BMI: ${bmi.toFixed(2)} (${bmiStatusText})\n‚öñÔ∏è ‡¶Ü‡¶¶‡¶∞‡ßç‡¶∂ ‡¶ì‡¶ú‡¶®: ${idealWeightRange}\n\nüéØ ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∞‡ßã ‡¶ó‡ßã‡¶≤:\n- ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡¶ø‡¶®: ${macros.protein.toFixed(0)} ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ\n- ‡¶ï‡¶æ‡¶∞‡ßç‡¶¨‡¶∏: ${macros.carbs.toFixed(0)} ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ\n- ‡¶´‡ßç‡¶Ø‡¶æ‡¶ü: ${macros.fat.toFixed(0)} ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ\n\nüíß ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ: ${waterIntake.toFixed(1)} ‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞`;

            modalContent.innerHTML = `
                <div class="flex justify-between items-center text-white"><h2 class="text-2xl font-bold">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡ßá‡¶≤‡¶• ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2><button id="share-btn" class="text-blue-400 hover:text-blue-300 p-2 rounded-full"><i class="fas fa-share-alt"></i></button></div>
                <div class="grid grid-cols-2 gap-4 my-4 text-white">
                    <div class="bg-black/20 p-4 rounded-lg animated-card" style="animation-delay: 0.1s;"><div class="text-sm text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ BMI</div><div class="text-3xl font-bold ${bmiStatusColor}">${bmi.toFixed(2)}</div><div class="text-sm font-semibold ${bmiStatusColor}">${bmiStatusText}</div></div>
                    <div class="bg-black/20 p-4 rounded-lg animated-card" style="animation-delay: 0.2s;"><div class="text-sm text-gray-400">‡¶Ü‡¶¶‡¶∞‡ßç‡¶∂ ‡¶ì‡¶ú‡¶®</div><div class="text-3xl font-bold text-green-400">${idealWeightRange}</div><div class="text-sm text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ</div></div>
                </div>
                <div class="p-5 bg-black/20 rounded-lg mb-4 animated-card text-white" style="animation-delay: 0.3s;">
                    <h3 class="font-semibold text-gray-300 mb-3 text-lg">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶™‡ßÅ‡¶∑‡ßç‡¶ü‡¶ø‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ</h3>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div><div class="text-sm text-blue-400">‡¶™‡ßç‡¶∞‡ßã‡¶ü‡¶ø‡¶®</div><div class="font-bold text-2xl">${macros.protein.toFixed(0)}<span class="text-sm text-gray-300"> ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</span></div></div>
                        <div><div class="text-sm text-orange-400">‡¶ï‡¶æ‡¶∞‡ßç‡¶¨‡¶∏</div><div class="font-bold text-2xl">${macros.carbs.toFixed(0)}<span class="text-sm text-gray-300"> ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</span></div></div>
                        <div><div class="text-sm text-yellow-400">‡¶´‡ßç‡¶Ø‡¶æ‡¶ü</div><div class="font-bold text-2xl">${macros.fat.toFixed(0)}<span class="text-sm text-gray-300"> ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</span></div></div>
                    </div>
                </div>
                <div class="p-5 bg-black/20 rounded-lg animated-card" style="animation-delay: 0.4s;">
                     <h3 class="font-semibold text-gray-300 mb-2 text-lg">‡¶ï‡ßÄ-‡¶á‡¶®‡¶∏‡¶æ‡¶á‡¶ü ‡¶ì ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂</h3>
                     <ul class="list-disc list-inside space-y-2 text-gray-300">
                        <li>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßà‡¶®‡¶ø‡¶ï <strong class="text-white">${waterIntake.toFixed(1)} ‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞</strong> ‡¶™‡¶æ‡¶®‡¶ø ‡¶™‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶â‡¶ö‡¶ø‡¶§‡•§</li>
                        <li>${bmi < 18.5 ? '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ú‡¶® ‡¶ï‡¶Æ ‡¶π‡¶ì‡ßü‡¶æ‡ßü, ‡¶™‡ßá‡¶∂‡¶ø ‡¶ó‡¶†‡¶®‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡¶ø‡¶®‡ßá‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ‡ßü ‡¶Æ‡¶®‡ßã‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®‡•§' : (bmi > 25 ? '‡¶ì‡¶ú‡¶® ‡¶®‡¶ø‡ßü‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£‡ßá ‡¶Ü‡¶®‡¶§‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶¨‡ßã‡¶π‡¶æ‡¶á‡¶°‡ßç‡¶∞‡ßá‡¶ü ‡¶ó‡ßç‡¶∞‡¶π‡¶£‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶≠‡¶æ‡¶¨‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§' : '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ú‡¶® ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø‡¶ï‡¶∞, ‡¶è‡¶ü‡¶ø ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶è‡¶á ‡¶™‡ßÅ‡¶∑‡ßç‡¶ü‡¶ø‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§')}</li>
                        <li>‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡ßü‡ßá‡¶ü ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶™‡ßÅ‡¶∑‡ßç‡¶ü‡¶ø‡¶¨‡¶ø‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø‡•§</li>
                    </ul>
                </div>
                <div class="p-4 bg-black/20 rounded-lg mt-4 animated-card text-center" style="animation-delay: 0.5s;">
                    <button id="pro-tip-btn" class="text-green-400 font-semibold hover:text-green-300 transition-colors"><i class="fas fa-star mr-2"></i>‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßã ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>
                <button id="close-modal-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;

            document.getElementById('close-modal-btn').addEventListener('click', tg.initData ? tg.close : closeModal); 
            document.getElementById('share-btn').addEventListener('click', () => shareReport(reportText));
            document.getElementById('pro-tip-btn').addEventListener('click', showRewardedInterstitialAd);
            openModal();
        }

        // --- Ad Integration Functions ---
        function showRewardedPopupAd() {
            unlockReportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            unlockReportBtn.disabled = true;
            show_9530643('pop').then(() => {
                showToast("‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶! ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                unlockScreen.classList.add('hidden');
                processAndShowResults(calculationData);
            }).catch(e => {
                showToast("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§", "error");
                unlockScreen.classList.add('hidden');
                processAndShowResults(calculationData);
            }).finally(() => {
                unlockReportBtn.innerHTML = '<i class="fas fa-play mr-2"></i> ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®';
                unlockReportBtn.disabled = false;
            });
        }

        function showRewardedInterstitialAd() {
            show_9530643().then(() => {
                alert('‡¶™‡ßç‡¶∞‡ßã ‡¶ü‡¶ø‡¶™‡¶∏: ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß©‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡ßü‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ì‡¶ú‡¶® ‡¶®‡¶ø‡ßü‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£‡ßá‡¶á ‡¶®‡ßü, ‡¶Æ‡¶æ‡¶®‡¶∏‡¶ø‡¶ï ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡¶ì ‡¶â‡¶™‡¶ï‡¶æ‡¶∞‡ßÄ!');
            }).catch(e => {
                showToast("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§", "error");
            });
        }

        // --- Utility Functions ---
        function showToast(message, type = 'success') { const toastContainer = document.getElementById('toast-container'); const toast = document.createElement('div'); const colors = { success: 'bg-green-500', error: 'bg-red-500' }; toast.className = `toast text-white px-4 py-3 rounded-lg shadow-lg ${colors[type]}`; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.classList.add('closing'); toast.addEventListener('animationend', () => toast.remove()); }, 3000); }
        function switchTab(tabName) {
            unlockScreen.classList.add('hidden');
            tabControls.classList.remove('hidden');
            calculatorTab.classList.remove('hidden');
            const isCalculator = tabName === 'calculator';
            calculatorTab.style.display = isCalculator ? 'block' : 'none';
            historyTab.style.display = isCalculator ? 'none' : 'block';
            calculatorTabBtn.classList.toggle('active', isCalculator);
            historyTabBtn.classList.toggle('active', !isCalculator);
            if (tg.initData) { try { if (isCalculator) { tg.MainButton.show(); validateFormForTelegram(); } else { tg.MainButton.hide(); } } catch(e) {} }
            if (!isCalculator) renderHistory();
        }
        function saveHistory(entry) { let history = JSON.parse(localStorage.getItem('bmiHistory')) || []; history.push(entry); localStorage.setItem('bmiHistory', JSON.stringify(history)); showToast("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); }
        
        // --- FINAL CORRECTED renderHistory FUNCTION ---
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('bmiHistory')) || [];
            historyLog.innerHTML = history.length === 0 ? `<p class="text-gray-400 text-center">‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>` : '';
            clearHistoryBtn.style.display = history.length > 0 ? 'block' : 'none';
            if (history.length > 0) {
                historyLog.innerHTML = ''; // Clear previous entries
                history.slice().reverse().forEach((entry, index) => {
                    const logItem = document.createElement('div');
                    logItem.className = 'flex justify-between items-center bg-indigo-900/50 p-3 rounded-lg text-sm text-white';
                    logItem.innerHTML = `<div><span class="font-semibold">${entry.date}</span> | BMI: <span class="font-bold">${entry.bmi}</span> | ‡¶ì‡¶ú‡¶®: ${entry.weight} ‡¶ï‡ßá‡¶ú‡¶ø</div><button data-index="${history.length - 1 - index}" class="delete-btn text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>`;
                    historyLog.appendChild(logItem);
                });
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', deleteHistoryItem));
            }
            renderChart(history);
        }
        function renderChart(history) { if (bmiChartInstance) bmiChartInstance.destroy(); if(history.length < 2) { chartCanvas.style.display='none'; return; } chartCanvas.style.display='block'; const labels = history.map(entry => entry.date), data = history.map(entry => entry.bmi); const chartTextColor = (window.Telegram.WebApp.themeParams && window.Telegram.WebApp.themeParams.text_color) || '#9ca3af'; bmiChartInstance = new Chart(chartCanvas.getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: 'BMI Trend', data, borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.2)', borderWidth: 2, tension: 0.4, fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false, ticks: { color: chartTextColor } }, x: { ticks: { color: chartTextColor } } } } }); }
        function deleteHistoryItem(e) { const index = e.currentTarget.dataset.index; let history = JSON.parse(localStorage.getItem('bmiHistory')) || []; history.splice(index, 1); localStorage.setItem('bmiHistory', JSON.stringify(history)); renderHistory(); showToast("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá", "error"); }
        function clearHistory() { if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) { localStorage.removeItem('bmiHistory'); renderHistory(); showToast("‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá", "error"); } }
        async function shareReport(text) { try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {} if (tg.initData && tg.isVersionAtLeast('6.7')) { try { tg.switchInlineQuery(text, ['users', 'bots', 'groups', 'channels']); } catch (e) { showToast('Share failed.', 'error'); } } else if (navigator.share) { try { await navigator.share({ title: '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡ßá‡¶≤‡¶• ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', text: text }); } catch (err) { console.error('Share failed:', err); } } else { navigator.clipboard.writeText(text).then(() => { showToast('‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!'); }); } }
        function openModal() { modalBackdrop.classList.remove('pointer-events-none', 'opacity-0'); modalContent.classList.remove('opacity-0', 'scale-95'); }
        function closeModal() { modalBackdrop.classList.add('opacity-0'); modalContent.classList.add('opacity-0', 'scale-95'); setTimeout(() => { modalBackdrop.classList.add('pointer-events-none'); }, 300); }
        function applyTelegramTheme(themeParams) { const root = document.documentElement; root.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#0f0c29'); root.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#ffffff'); root.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#9ca3af'); root.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#3b82f6'); root.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff'); root.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || 'rgba(26, 26, 46, 0.6)'); if (tg.colorScheme === 'light') { document.body.classList.remove('original-gradient-bg'); root.style.setProperty('--tg-theme-input-bg-color', '#e5e7eb'); } else { document.body.classList.add('original-gradient-bg'); root.style.setProperty('--tg-theme-input-bg-color', 'rgba(71, 85, 105, 0.4)'); } }
        function validateFormForTelegram() { if (!tg.initData) return; try { const age = ageInput.value, weight = weightInput.value, feet = heightFeetInput.value; if (selectedGender && age && weight && feet) { tg.MainButton.enable(); } else { tg.MainButton.disable(); } } catch (e) {} }

        // --- Telegram & App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (window.Telegram && window.Telegram.WebApp.initData) {
                    tg.ready();
                    tg.expand();
                    applyTelegramTheme(tg.themeParams);
                    tg.onEvent('themeChanged', () => applyTelegramTheme(tg.themeParams));
                    tg.MainButton.setText('‡¶π‡ßá‡¶≤‡¶• ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®');
                    tg.MainButton.onClick(handleCalculation);
                    tg.MainButton.show();
                    submitBtnContainer.classList.add('tg-hidden');
                    validateFormForTelegram();
                    if (typeof show_9530643 === 'function') {
                        show_9530643({ type: 'inApp', inAppSettings: { frequency: 2, capping: 0.1, interval: 30, timeout: 5, everyPage: false } });
                    }
                }
            } catch(e) {
                console.error("Telegram Web App features failed to initialize. Running in standard browser mode.", e);
            }
        });
    </script>
</body>
</html>